<?php


/**
 * Basic Entity Source tests.
 *
 * @todo: Write tests for these cases:
 *  - any generic entity (defined by the tmgmt_entity_test module).
 */
class TMGMTNodeSourceTestCase extends TMGMTBaseTestCase {

  /**
   * Implements getInfo().
   */
  static function getInfo() {
    return array(
      'name' => t('Node Source tests'),
      'description' => t('Exporting source data from nodes and saving translations back to nodes'),
      'group' => t('Translation Management'),
    );
  }

  /**
   * Overrides SimplenewsTestCase::setUp()
   */
  function setUp() {
    parent::setUp(array('tmgmt_node', 'translation'));
    $this->admin_user = $this->drupalCreateUser(array('administer languages', 'access administration pages', 'administer content types'));
    variable_set('language_content_type_page', TRANSLATION_ENABLED);

    // Copied from standard.install
    $type = array(
      'type' => 'page',
      'name' => st('Basic page'),
      'base' => 'node_content',
      'description' => st("Use <em>basic pages</em> for your static content, such as an 'About us' page."),
      'custom' => 1,
      'modified' => 1,
      'locked' => 0,
    );
    $type = node_type_set_defaults($type);
    node_type_save($type);
    node_add_body_field($type);
    node_types_rebuild();
  }

  /**
   * Adds some fields to an entity bundle
   *
   * @param $bundle
   *   The entity bundle.
   */
  function addFields($bundle = 'article') {
    $field_types = array('text', 'text_with_summary');
    $this->field_names[$bundle][] = 'body';

    for ($i = 0 ; $i <= 5; $i++) {
      $field_type = $field_types[array_rand($field_types, 1)];
      $field_name = drupal_strtolower($this->randomName());

      // Create a field.
      $field = array(
        'field_name' => $field_name,
        'type' => $field_type,
        'cardinality' => $i,
        'translatable' => TRUE  ,
      );
      field_create_field($field);

      // Create an instance of the previously created field.
      $instance = array(
        'field_name' => $field_name,
        'entity_type' => 'node',
        'bundle' => $bundle,
        'label' => $this->randomName(10),
        'description' => $this->randomString(30),
        'widget' => array(
          'type' => $field_type == 'text' ? 'text_textfield' : 'text_textarea_with_summary',
          'label' => $this->randomString(10),
        ),
      );
      field_create_instance($instance);

      $this->field_names[$bundle][] = $field_name;
    }
  }

  /**
   * Tests nodes field translation.
   */
  function testNodeSource() {
    $this->drupalLogin($this->admin_user);
    $this->setEnvironment('de');

    foreach (array('article', 'page') as $content_type) {
      // Check if this item type is translatable by the node source plugin.
      if (tmgmt_source_is_translatable_item_type('node', $content_type)) {
        // Add some fields.
        $this->addFields($content_type);

        // Create a translation job.
        $job = $this->createJob();
        $job->translator = $this->default_translator->name;
        $job->settings = array();
        $job->save();

        for ($i = 0; $i <= 5; $i++) {
          $node = array(
            'type' => $content_type,
            'language' => 'en',
            'translate' => TRUE,
          );

          // Put some values in the new fields.
          foreach ($this->field_names[$content_type] as $field_name) {
            $field_info = field_info_field($field_name);
            $cardinality = $field_info['cardinality'] == FIELD_CARDINALITY_UNLIMITED ? 1 : $field_info['cardinality'];

            // Create two deltas for each field.
            for ($delta = 0; $delta <= $cardinality; $delta++) {
              $node[$field_name]['en'][$delta]['value'] = $this->randomString(20);
              if ($field_info['type'] == 'text_with_summary') {
                $node[$field_name]['en'][$delta]['summary'] = $this->randomString(10);
              }
            }
          }
          $node = $this->drupalCreateNode($node);

          // Create a job item for this node and add it to the job.
          $job->addItem('node', $content_type, $node->nid);
        }

        // Translate the job.
        $job->requestTranslation();

        foreach ($job->getItems() as $item) {
          $item->acceptTranslation();
          $node = node_load($item->item_id);
          // Check if the tnid attribute is bigger than 0.
          $this->assertTrue($node->tnid > 0, t('The source node is part of a translation set.'));
          // The translations may be statically cached, so make make sure
          // to reset the cache before loading the node translations.
          $cached_translations = &drupal_static('translation_node_get_translations', array());
          unset($cached_translations[$node->tnid]);
          // Load the translation set of the source node.
          $translations = translation_node_get_translations($node->tnid);
          $this->assertNotNull($translations['de'], t('Translation found for the source node.'));
          if (isset($translations['de'])) {
            $tnode = node_load($translations['de']->nid, NULL, TRUE);
            $this->checkTranslatedData($tnode, $item->getData(), 'de');
          }
        }
      }
    }
  }

  /**
   * Compares the data from an entity with the translated data.
   *
   * @param $node
   *  The translated node object.
   * @param $data
   *  An array with the translated data.
   * @param $langcode
   *  The code of the target language.
   */
  function checkTranslatedData($node, $data, $langcode) {
    foreach (element_children($data) as $field_name) {
      if ($field_name == 'node_title') {
        $this->assertEqual($node->title, $data['node_title']['#translation']['#text'], t('The title of the translated node matches the translated data.'));
        continue;
      }
      foreach (element_children($data[$field_name]) as $delta) {
        foreach (element_children($data[$field_name][$delta]) as $column) {
          $column_value = $data[$field_name][$delta][$column];
          if (!isset($column_value['#translate']) || $column_value['#translate']) {
            $this->assertEqual($node->{$field_name}[$langcode][$delta][$column], $column_value['#translation']['#text'], t('The translatable field %field:%delta has been populated with the proper translated data.', array('%field' => $field_name, 'delta' => $delta)));
          }
        }
      }
    }
  }
}
