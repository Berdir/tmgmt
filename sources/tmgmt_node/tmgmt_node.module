<?php
/**
 * @file
 * Source plugin for the Translation Management system that handles nodes.
 */

/**
 * Implements hook_menu().
 */
function tmgmt_node_menu() {
  $items['node/%node/create-job'] = array(
    'title' => t('Translation management'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tmgmt_node_translator_settings_form', 1),
    'access callback' => '_translation_tab_access',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
    'weight' => 20
  );
  return $items;
}

function tmgmt_node_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'tmgmt_node') . '/includes/views',
  );
}

/**
 * The Node translator settings form.
 */
function tmgmt_node_translator_settings_form($form, &$form_state, $node) {
  // Check for pending jobs.
  $jobs = tmgmt_job_load_multiple_by_source('node', 'node', $node->vid);
  if (!empty($jobs)) {
    $view = views_get_view('job_items_current_node');
    $form['joblist'] = array(
      '#type' => 'item',
      '#title' => t('Pending jobs'),
      '#markup' => views_embed_view('job_items_current_node', 'default', $node->vid),
    );
  }

  // Get all available languages from core translation module.
  $available_languages = entity_metadata_language_list();
  // Pull the label of the node language.
  $node_language = $available_languages[$node->language];
  // Remove LANGUAGE_NONE and the source language from the list of available
  // languages.
  unset($available_languages[LANGUAGE_NONE], $available_languages[$node->language]);

  $form['source_language_display'] = array(
    '#type' => 'item',
    '#title' => t('Source language'),
    '#markup' => $node_language,
  );

  $form['source_language'] = array(
    '#type' => 'hidden',
    '#value' => $node->language,
  );

  $form['target_language'] = array(
    '#type' => 'select',
    '#title' => t('Target language'),
    '#description' => t('The target language'),
    '#options' => $available_languages,
  );

  // Get the translator plugin that is currently selected.
  $translator_plugins = tmgmt_translator_plugin_labels(TRUE);
  $translator_plugins_keyed = array_keys($translator_plugins);
  $selected_translator_plugin = isset($form_state['values']['translation_service']) ? $form_state['values']['translation_service'] : reset($translator_plugins_keyed);

  $form['translation_service'] = array(
    '#type' => 'select',
    '#title' => t('Translation type'),
    '#options' => $translator_plugins,
    '#default_value' => $selected_translator_plugin,
    '#ajax' => array(
      'callback' => 'tmgmt_node_get_translator_options',
      'wrapper' => 'tmgmt-translator-options',
      'method' => 'replace',
    ),
  );

  $form['options'] = array(
    '#type' => 'container',
    '#prefix' => '<div id="tmgmt-translator-options">',
    '#suffix' => '</div>',
  );

  $info = tmgmt_translator_plugin_info($selected_translator_plugin);

  $form['options']['description'] = array(
    '#type' => 'item',
    '#title' => t('About this service'),
    '#markup' => $info['description'],
  );

  $form['nid'] = array(
    '#type' => 'hidden',
    '#value' => $node->nid,
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('create job'),
    '#weight' => 50,
  );

  return $form;
}

/**
 * ajax callbackfunction to fetch the options provided by a translator.
 */
function tmgmt_node_get_translator_options($form, &$form_state) {
  $active_translator = $form_state['values']['translation_service'];
  $translator = tmgmt_translator_plugin_info($active_translator);

  $form['options']['description'] = array(
    '#type' => 'item',
    '#title' => t('About this service'),
    '#markup' => t($translator['description']),
  );
  return $form['options'];
}

/**
 * node translator submit function.
 * will create a job with the node as item.
 */
function tmgmt_node_translator_settings_form_submit($form, &$form_state) {

  $values = $form_state['values'];

  // create the job object.
  $job = tmgmt_job_create($values['source_language'], $values['target_language']);

  // add the selected translator.
  $job->translator = $values['translation_service'];
  $job->save();
  // create a job item and add it to the job.
  $item = tmgmt_job_item_create('node', 'node', $values['nid']);
  $job->addItem($item);

  drupal_set_message(t('Translation job has been created.'));

  // Mark the job as prepared.
  $job->setState(TMGMTJob::STATE_PREPARED);
  $job->save();
}

/**
 * Implements hook_tmgmt_source_plugin_info().
 *
 * @ingroup source
 */
function tmgmt_node_tmgmt_source_plugin_info() {
  return array(
    'node' => array(
      'label' => t('Node'),
      'description' => t('Source handler for nodes.'),
      'controller class' => 'TMGMTNodeSourcePluginController',
    ),
  );
}

/**
 * Updates a node translation.
 *
 * @param object $node
 *   The translated node object (the target).
 *
 * @param array $translated_data
 *   An array with the structured translated data.
 *   @see TMGMTNodeSourcePluginController::getData().
 */
function tmgmt_node_update_node_translation($node, $translated_data, $target_language) {
  foreach ($translated_data as $field_name => $values) {
    // Special case for the node title.
    if ($field_name == 'node_title') {
      $node->title = $values[0]['value']['#text'];
      continue;
    }
    $index = 0;
    $field_info = field_info_field($field_name);
    foreach ($values as $key => $value) {
      $tdata = array();
      foreach ($value as $input_name => $input_value) {
        $tdata[$input_name] = $input_value['#text'];
      }
      $field_lang = LANGUAGE_NONE;
      if ($field_info['translatable']) {
        $field_lang = $target_language;
      }
      $node->{$field_name}[$field_lang][$index] = array_merge($node->{$field_name}[$field_lang][$index], $tdata);
      $index++;
    }
  }
  node_save($node);
}

/**
 * Implements hook_tmgmt_source_translation_structure() for the text module.
 *
 * @todo: this hook should probably be placed elsewhere.
 */
function text_tmgmt_source_translation_structure($field_name, $entity, $field_info, $field_instance, $job_item) {
  $job = tmgmt_job_load($job_item->tjid);
  $field_lang = field_language($job_item->item_type, $entity, $field_name);
  $structure = array();
  if (!empty($entity->{$field_name})) {
    foreach ($entity->{$field_name}[$field_lang] as $key => $value) {
      $structure[$key]['value'] = array(
        '#label' => t('!field_name: Value nr. !count', array('!field_name' => $field_instance['label'], '!count' => $key), array('langcode' => $job->source_language)),
        '#text' => $value['value'],
        '#translate' => TRUE,
      );
      if ($field_info['type'] == 'text_with_summary' && !empty($value['summary'])) {
        $structure[$key]['summary'] = array(
          '#label' => t('!field_name: Summary nr. !count', array('!field_name' => $field_instance['label'], '!count' => $key), array('langcode' => $job->source_language)),
          '#text' => $value['summary'],
          '#translate' => TRUE
        );
      }
    }
  }
  return $structure;
}
